---
title: "02_Greenhouse_Trials"
author: "Matt"
date: "9/14/2020"
output: html_document
---

The intention of this document is to perform scientific analysis of the greenhouse trials performed in my MSc. This will include everything from greenhouse temperature data to biomass and carbon sampling as well.

I'll start with biomass collected in the greenhouse. First, load some packages

```{r}

suppressMessages(suppressWarnings({
  ls <- c("tidyverse", "broom", "car", "ggpubr", "magick", "agricolae", "extrafont")
  new_packages <- ls[!(ls %in% installed.packages()[, "Package"])]
  if(length(new_packages)) install.packages(new_packages)
  sapply(ls, library, character.only = TRUE, quietly = TRUE)[0]
  if(any(!fonts() %in% unlist(windowsFonts()))) {
    font_import(prompt = FALSE)
    loadfonts(device = "win")}
  rm(ls, new_packages)}))

```

Next, initialize folders and load the data

```{r}

data_dir <- file.path("./02_Greenhouse/data")
plot_dir <- file.path("./02_Greenhouse/plots")
results_dir <- file.path("./02_Greenhouse/results")
dir.create(plot_dir, showWarnings = FALSE)
dir.create(results_dir, showWarnings = FALSE)

biomass <- read.csv(file.path(data_dir, "greenhouse_raw.csv"), header = TRUE) %>% 
  dplyr::mutate(Soil_Type = factor(Soil_Type, levels = c("Invaded", "Pristine")),
                Soil_Treatment = factor(Soil_Treatment, levels = c("Con", "AC", "Ash")), 
                AboveMass = ifelse(AboveMass == 0.001, 0, AboveMass),
                BelowMass = ifelse(BelowMass == 0.001, 0, BelowMass),
                TotalMass = AboveMass + BelowMass) %>% 
  dplyr::select(Soil_Type, Soil_Treatment, Species, TotalMass)

```

Let's see if the data are normal or not. This requires separating by species since they have very different growth patterns etc.

For both species, test if residuals are significantly different (lots of variation). If so, the data are not normal and something needs to be done to it.

```{r biomass stats}

bmass_assumptions <- sapply(unique(biomass$Species), function (x) {
  df <- dplyr::filter(biomass, Species == x)
  aov <- aov(TotalMass ~ Soil_Type * Soil_Treatment, data = df)
  resid <- residuals(aov)
  shapiro <- shapiro.test(resid) %>% tidy() %>% dplyr::mutate(stat_name = names(statistic))
  levene <- leveneTest(TotalMass ~ Soil_Type * Soil_Treatment, data = df) %>% 
    drop_na()
  return(list(shapiro = shapiro, levene = levene))
}, simplify = FALSE, USE.NAMES = TRUE)

bmass_normal_analysis <- lapply(bmass_assumptions, "[[", 1) %>% do.call(rbind, .)
bmass_var_eq_analysis <- lapply(bmass_assumptions, "[[", 2) %>% do.call(rbind, .)

# Neither SK or RF pass the normality test, so I'll transform the data using a 
# log transformation and see if that works. As an aside, only the RF data had
# significantly unequal variances, SK was fine.

biomass$LogMass <- log10(biomass$TotalMass + 1)
bmass_log_assumptions <- sapply(unique(biomass$Species), function (x) {
  df <- dplyr::filter(biomass, Species == x)
  aov <- aov(LogMass ~ Soil_Type * Soil_Treatment, data = df)
  resid <- residuals(aov)
  shapiro <- shapiro.test(resid) %>% tidy() %>% dplyr::mutate(stat_name = names(statistic))
  levene <- leveneTest(LogMass ~ Soil_Type * Soil_Treatment, data = df) %>% 
    drop_na()
  return(list(shapiro = shapiro, levene = levene))
}, simplify = FALSE, USE.NAMES = TRUE)

bmass_log_normal_analysis <- lapply(bmass_log_assumptions, "[[", 1) %>% do.call(rbind, .)
bmass_log_var_eq_analysis <- lapply(bmass_log_assumptions, "[[", 2) %>% do.call(rbind, .)

# The results came back passing all assumptions, and now a proper 2-way ANOVA can
# be carried out (and post hoc analysis, Tukey HSD):
bmass_analysis <- sapply(unique(biomass$Species), function(x) {
  df <- dplyr::filter(biomass, Species == x)
  aov <- aov(LogMass ~ Soil_Type * Soil_Treatment, data = df)
  anova <- anova(aov) %>% tidy() %>% mutate(SPECIES = x)
  tukey <- TukeyHSD(aov) %>% tidy() %>% mutate(SPECIES = x)
  return(list(anova = anova, tukey = tukey))
}, simplify = FALSE, USE.NAMES = TRUE)

# In both cases, there is a strong 'Soil_Treatment' effect, and a slight interaction
# effect ('Soil_Type:Soil_Treatment').
# Most of the differences are from using AC in the soils (which killed everything).

# Write outputs
write.csv(bmass_normal_analysis, file.path(
  results_dir, "01a_biomass_normal_assumptions.csv"), row.names = TRUE)
write.csv(bmass_var_eq_analysis, file.path(
  results_dir, "01b_biomass_var_eq_assumptions.csv"), row.names = TRUE)

unlink(file.path(results_dir, c("01c_biomass_anova.csv", "01d_biomass_tukey.csv")))
bmass_anova <- lapply(bmass_analysis, "[[", "anova") %>% 
  lapply(function(x) {
    df <- x
    df[nrow(df) + 1, ] <- NA
    write.table(df, file.path(results_dir, "01c_biomass_anova.csv"), append = TRUE, 
                row.names = FALSE, sep = ",", na = "")
    return(x) 
  })
bmass_tukey <- lapply(bmass_analysis, "[[", "tukey") %>% 
  lapply(function(x) {
    df <- x
    df[nrow(df) + 1, ] <- NA
    write.table(df, file.path(results_dir, "01d_biomass_tukey.csv"), append = TRUE, 
                row.names = FALSE, sep = ",", na = "")
    return(x) 
  })

```

After the stats, let's make some figures from that data:

```{r biomass figures}

# First, let's make bar charts for the biomass, and afterwards a boxplot, then 
# finally a side-by-side interaction plot. For the bar chart, we need means and
# standard errors of the LogBiomass data, which means creating a new summarized data table
biomass_summary <- biomass %>% 
  dplyr::group_by(Soil_Type, Soil_Treatment, Species) %>% 
  dplyr::summarise(mean = mean(LogMass), se = sd(LogMass) / sqrt(n()), .groups = "drop")

#This basically tells us that rough fescue performed best in invaded soils. Odd, but it's a result.
#Now, since I mentioned interactions, I should provide interaction plots for visualization purposes
#I will make the plots and then join them with a common legend afterwards
interactions <- sapply(unique(biomass_summary$Species), function(x) {
  p <- ggplot(subset(biomass_summary, Species == x), 
              aes(Soil_Type, mean, group = Soil_Treatment, linetype = Soil_Treatment)) + 
    geom_line(size = 1) +
    geom_point(size = 2) +
    theme_classic(base_size = 14) +
    theme(
      text = element_text(family = "Times New Roman"),
      legend.position = "none",
      legend.background = element_rect(
        fill = "white",
        size = 1,
        linetype = "solid",
        colour = "black"
      ),
      legend.title = element_text(face = "bold"),
      axis.text = element_text(colour = "black"),
      axis.ticks.x = element_blank(),
      axis.ticks.y = element_line(size = 1, linetype = "solid", colour = "black"),
      axis.title = element_text(face = "bold", size = 16),
      axis.title.y = element_text(margin = margin(t = 0, 10, 0, 0)),
      axis.line = element_line(size = 1),
      plot.title = element_text(face = "bold", hjust = 0.5)
    ) +
    scale_y_continuous(expand = c(0, 0), limits = c(0, 1)) +
    scale_x_discrete(labels = c("Invaded", "Pristine")) +
    scale_linetype_manual(
      values = c("solid", "dashed", "dotted"),
      name = "Soil Treatment:",
      breaks = c("Con", "AC", "Ash"),
      labels = c("Control", "Activated Carbon", "Ash")
    ) +
    xlab("Soil Type") +
    ylab("Log (Biomass (g) +1)") +
    ggtitle(ifelse(x == "RF", "Rough Fescue", "Spotted Knapweed"))
}, simplify = FALSE, USE.NAMES = TRUE)

#Now join those 2 graphs together
final <- ggarrange(plotlist = interactions, common.legend = TRUE, legend = "bottom") +
  ggsave(filename = file.path(plot_dir, "interactions.png"), width = 6, height = 3, dpi = 300)
#Export image at 600px wide x 300px tall

```

Now, plot biomass separated by species. There is also the option of adding an image of the plant to the graphs as well

```{r Biomass separated}

rf_img <- image_read(
  "https://live.staticflickr.com/2426/3990317298_1cfbb2e31f_o_d.jpg") %>% 
  image_rotate(90) %>% 
  as.raster()
rf_img_ar <- ncol(rf_img) / nrow(rf_img)

sk_img <- image_read(
  "https://upload.wikimedia.org/wikipedia/commons/2/2d/Centaurea_maculosa_Bozeman.jpg") %>% 
  as.raster()
sk_img_ar <- ncol(rf_img) / nrow(rf_img)

biomass_plot <- sapply(unique(biomass_summary$Species), function(x) {
  df <- subset(biomass, Species == x) %>% 
    unite(trt, c("Soil_Type", "Soil_Treatment"), remove = FALSE) %>% 
    dplyr::mutate(Soil_Treatment = factor(Soil_Treatment, levels = c("AC", "Ash", "Con")))
  df_summary <- subset(biomass_summary, Species == x) %>% 
    unite(trt, c("Soil_Type", "Soil_Treatment"), remove = FALSE) %>% 
    dplyr::mutate(Soil_Treatment = factor(Soil_Treatment, levels = c("AC", "Ash", "Con")))
  
  # Get significance letters using HSD.test from agricolae package
  df_summary <- HSD.test(aov(LogMass ~ trt, data = df),trt = "trt", group = TRUE)$groups %>% 
    rownames_to_column("trt") %>% 
    dplyr::select(-LogMass) %>% 
    merge(df_summary)
  
  p <- ggplot(subset(df_summary, Species == x), 
              aes(Soil_Treatment, mean, fill = Soil_Type)) +
    geom_bar(
      stat = "identity",
      position = "dodge",
      colour = "black",
      size = 1) +
    geom_errorbar(
      aes(ymin = mean - se, ymax = mean + se),
      size = 1,
      width = 0.3,
      position = position_dodge(0.9)) +
    ggtitle(ifelse(x == "RF", "Rough Fescue", "Spotted Knapweed")) +
    xlab("Soil Amendment") +
    ylab("Log (Biomass (g) + 1)") +
    scale_fill_manual(
      values = c("#5a5a5a", "#adadad"),
      breaks = c("Invaded", "Pristine"),
      labels = c("Invaded", "Pristine"),
      name = "Soil Type:") +
    theme_classic(base_size = 14) +
    theme(
      rect = element_rect(fill = "transparent"),
      text = element_text(family = "Times New Roman"),
      legend.position = c(0.12, 0.88),
      legend.background = element_rect(
        fill = "white",
        size = 1,
        linetype = "solid",
        colour = "black"),
      legend.title = element_text(face = "bold", size = 16),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.text = element_text(colour = "black"),
      axis.ticks.x = element_blank(),
      axis.ticks.y = element_line(size = 1, linetype = "solid", colour = "black"),
      axis.title = element_text(face = "bold", size = 16),
      axis.title.y = element_text(margin = margin(t = 0, 10, 0, 0)),
      axis.line = element_line(size = 1),
      plot.title = element_text(face = "bold", hjust = 0.5)) +
    scale_y_continuous(expand = c(0, 0), limits = c(0, 1)) +
    scale_x_discrete(labels = c(AC = "AC", Ash = "Ash", Con = "Control")) +
    geom_text(
      aes(label = groups, y = mean + se),
      position = position_dodge(0.9),
      vjust = -0.5,
      family = "serif", 
      size = 5)
}, simplify = FALSE, USE.NAMES = TRUE)

biomass_plot <- ggarrange(plotlist = biomass_plot, common.legend = TRUE, legend = "bottom") +
  ggsave(file.path(plot_dir, "bmass.png"), width = 6, height = 3, dpi = 300)

# If images are to be included, run the following lines:
final <- biomass_plot + 
  annotation_raster(rf_img, xmin = 0.14, 
                    xmax = 0.24,
                    ymin = 0.6,
                    ymax = 0.85) + 
  annotation_raster(sk_img, xmin = 0.64, 
                    xmax = 0.74,
                    ymin = 0.6,
                    ymax = 0.85) + 
  ggsave(file.path(plot_dir, "bmass_with_images.png"), width = 6, height = 3, dpi = 300)

```

I need to do some stuff with survival of the planted greenhouse plants as well:

```{r}

# Read in the survival data from the same spreadsheet
surv <- read.csv(file.path(data_dir, "greenhouse_raw.csv"), header = TRUE) %>% 
  dplyr::select(-c(AboveMass, BelowMass, Rep)) %>% 
  dplyr::mutate(Soil_Type = factor(Soil_Type, levels = c("Invaded", "Pristine")),
                Soil_Treatment = factor(Soil_Treatment, levels = c("Con", "AC", "Ash")), 
                germ_rat = Germinants / 5, 
                deaths = Germinants - Survival, 
                trial_surv = Survival / 5, 
                germ_surv = ifelse(Survival == 0 & Germinants == 0, 0, 
                                   Survival / Germinants))

# Create summarized results
surv_summary <- group_by(surv, Soil_Type, Soil_Treatment, Species) %>% 
  summarise(across(c(germ_rat, deaths, trial_surv, germ_surv), 
                   list(mean = mean, se = ~sd(.x) / sqrt(n()))), .groups = "drop")

# Generate list of names that will be used to filter and attribute things later
plots <- names(surv_summary)[endsWith(names(surv_summary), "mean")]

surv_aovs <- sapply(plots, function(x) {
  df <- dplyr::rename(surv, data = all_of(gsub("_mean", "", x)))
  iter <- sapply(unique(df$Species), function(y) {
    df2 <- dplyr::filter(df, Species == y)
    aov <- aov(data ~ Soil_Type * Soil_Treatment, data = df2)
    resid <- residuals(aov)
    shapiro <- shapiro.test(resid) %>% tidy() %>% 
      dplyr::mutate(stat_name = names(statistic), SPECIES = y, test_var = x)
    levene <- leveneTest(data ~ Soil_Type * Soil_Treatment, data = df2) %>% 
      drop_na() %>% dplyr::mutate(SPECIES = y, test_var = x)
    return(list(shapiro = shapiro, levene = levene))
  }, simplify = FALSE, USE.NAMES = TRUE)
}, simplify = FALSE, USE.NAMES = TRUE)

# Summarized dataframes of normality and equal variance assumptions
surv_shapiro <- c(
  lapply(surv_aovs, "[[", c(1, 1)) %>% magrittr::set_names(paste0(names(.), "_RF")), 
  lapply(surv_aovs, "[[", c(2, 1)) %>% magrittr::set_names(paste0(names(.), "_SK"))) %>% 
  do.call(rbind, .)
surv_levene <- c(
  lapply(surv_aovs, "[[", c(1, 2)) %>% magrittr::set_names(paste0(names(.), "_RF")), 
  lapply(surv_aovs, "[[", c(2, 2)) %>% magrittr::set_names(paste0(names(.), "_SK"))) %>% 
  do.call(rbind, .)

# Most of the assumptions were violated, so try transforming it and see if that helps
surv_log <- mutate(surv, across(starts_with(gsub("_mean", "", plots)), ~log10(.x + 1)))
surv_log_summary <- group_by(surv_log, Soil_Type, Soil_Treatment, Species) %>% 
  summarise(across(c(germ_rat, deaths, trial_surv, germ_surv), 
                   list(mean = mean, se = ~sd(.x) / sqrt(n()))), .groups = "drop")

surv_log_aovs <- sapply(plots, function(x) {
  df <- dplyr::rename(surv_log, data = all_of(gsub("_mean", "", x)))
  iter <- sapply(unique(df$Species), function(y) {
    df2 <- dplyr::filter(df, Species == y)
    aov <- aov(data ~ Soil_Type * Soil_Treatment, data = df2)
    resid <- residuals(aov)
    shapiro <- shapiro.test(resid) %>% tidy() %>% 
      dplyr::mutate(stat_name = names(statistic), SPECIES = y, test_var = x)
    levene <- leveneTest(data ~ Soil_Type * Soil_Treatment, data = df2) %>% 
      drop_na() %>% dplyr::mutate(SPECIES = y, test_var = x)
    return(list(shapiro = shapiro, levene = levene))
  }, simplify = FALSE, USE.NAMES = TRUE)
}, simplify = FALSE, USE.NAMES = TRUE)

# Summarized dataframes of normality and equal variance assumptions
surv_log_shapiro <- c(
  lapply(surv_log_aovs, "[[", c(1, 1)) %>% magrittr::set_names(paste0(names(.), "_RF")), 
  lapply(surv_log_aovs, "[[", c(2, 1)) %>% magrittr::set_names(paste0(names(.), "_SK"))) %>% 
  do.call(rbind, .)
surv_log_levene <- c(
  lapply(surv_log_aovs, "[[", c(1, 2)) %>% magrittr::set_names(paste0(names(.), "_RF")), 
  lapply(surv_log_aovs, "[[", c(2, 2)) %>% magrittr::set_names(paste0(names(.), "_SK"))) %>% 
  do.call(rbind, .)

# Log transforming helped with some of the data to be able to perform an ANOVA;
# Other tests will need to be made using the non parametric Friedman 2-way ANOVA
# Define which are good for ANOVA vs. not
surv_which_anova <- dplyr::select(surv_log_shapiro, test_var, p.value, SPECIES) %>% 
  merge(dplyr::select(surv_log_levene, test_var, `Pr(>F)`, SPECIES), by = c("SPECIES", "test_var")) %>% 
  dplyr::mutate(anova = ifelse(p.value < 0.05 & `Pr(>F)` < 0.05, TRUE, FALSE), 
                test_var = gsub("_mean", "", test_var))

surv_anova_data <- dplyr::filter(surv_which_anova, anova == TRUE)
surv_anova <- lapply(1:nrow(surv_anova_data), function(x) {
  df <- dplyr::filter(surv_log, Species == surv_anova_data$SPECIES[x]) %>% 
    dplyr::select(Soil_Type, Soil_Treatment, all_of(surv_anova_data$test_var[x])) %>% 
    dplyr::rename(data = surv_anova_data$test_var[x])
  aov <- aov(data ~ Soil_Type * Soil_Treatment, data = df)
  anova <- anova(aov) %>% tidy() %>% 
    mutate(id = paste0("log_", surv_anova_data$test_var[x], "_", surv_anova_data$SPECIES[x]))
  tukey <- TukeyHSD(aov) %>% tidy() %>% 
    mutate(id = paste0("log_", surv_anova_data$test_var[x], "_", surv_anova_data$SPECIES[x]))
  return(list(anova = anova, tukey = tukey))
}) %>% magrittr::set_names(paste0("log_", surv_anova_data$test_var, "_", surv_anova_data$SPECIES))

surv_friedman_data <- dplyr::filter(surv_which_anova, anova == FALSE)
surv_friedman <- lapply(1:nrow(surv_friedman_data), function(x) {
  df <- dplyr::filter(surv, Species == surv_friedman_data$SPECIES[x]) %>% 
    dplyr::select(Soil_Type, Soil_Treatment, all_of(surv_friedman_data$test_var[x])) %>% 
    dplyr::rename(data = surv_friedman_data$test_var[x])
  df_summary <- dplyr::filter(surv_summary, Species == surv_friedman_data$SPECIES[x]) %>% 
    dplyr::select(Soil_Type, Soil_Treatment, all_of(paste0(surv_friedman_data$test_var[x], "_mean"))) %>% 
    dplyr::rename(data = paste0(surv_friedman_data$test_var[x], "_mean"))
  friedman <- friedman.test(data ~ Soil_Treatment | Soil_Type, data = df_summary) %>% 
    tidy() %>% 
    mutate(id = paste0(surv_friedman_data$test_var[x], "_", surv_friedman_data$SPECIES[x]))
  aov <- aov(data ~ Soil_Type * Soil_Treatment, data = df)
  tukey <- TukeyHSD(aov) %>% tidy() %>% 
    mutate(id = paste0(surv_friedman_data$test_var[x], "_", surv_friedman_data$SPECIES[x]))
  return(list(friedman = friedman, tukey = tukey))
}) %>% magrittr::set_names(paste0(surv_friedman_data$test_var, "_", surv_friedman_data$SPECIES))

surv_friedman_analysis <- lapply(surv_friedman, "[[", "friedman") %>% do.call(rbind, .)
surv_friedman_tukey <- lapply(surv_friedman, "[[", "tukey") 

# While looking into the matter, a non-parametric 2-way ANOVA is tricky with replication,
# so it had to be performed on mean data. Also, it doesn't produce interactions, 
# I made those the standard way which may be incorrect, not sure.

# Save outputs
unlink(file.path(results_dir, paste0("02e_survival_anova.csv", 
                                     "02f_survival_tukey.csv", 
                                     "02h_survival_friedman_tukey.csv")))
write.csv(surv_shapiro, file.path(
  results_dir, "02a_survival_normal_assumptions.csv"), row.names = TRUE)
write.csv(surv_levene, file.path(
  results_dir, "02b_survival_var_eq_assumptions.csv"), row.names = TRUE)
write.csv(surv_log_shapiro, file.path(
  results_dir, "02c_survival_log_normal_assumptions.csv"), row.names = TRUE)
write.csv(surv_log_levene, file.path(
  results_dir, "02d_survival_log_var_eq_assumptions.csv"), row.names = TRUE)
surv_anova_out <- lapply(surv_anova, "[[", "anova") %>% 
  lapply(function(x) {
    df <- x
    df[nrow(df) + 1, ] <- NA
    write.table(df, file.path(results_dir, "02e_survival_anova.csv"), append = TRUE, 
                row.names = FALSE, sep = ",", na = "")
    return(x)})
surv_tukey_out <- lapply(surv_anova, "[[", "tukey") %>% 
  lapply(function(x) {
    df <- x
    df[nrow(df) + 1, ] <- NA
    write.table(df, file.path(results_dir, "02f_survival_tukey.csv"), append = TRUE, 
                row.names = FALSE, sep = ",", na = "")
    return(x)})

write.csv(surv_friedman_analysis, file.path(
  results_dir, "02g_survival_friedman.csv"), row.names = FALSE)
lapply(surv_friedman_tukey, function(x) {
    df <- x
    df[nrow(df) + 1, ] <- NA
    write.table(df, file.path(results_dir, "02h_survival_friedman_tukey.csv"), append = TRUE, 
                row.names = FALSE, sep = ",", na = "")
    return(x)})

```

Now plot the survival data

```{r survival plots}

surv_plots <- sapply(plots, function(x) {
  
  df <- dplyr::select(surv, Soil_Type, Soil_Treatment, Species, all_of(gsub("_mean", "", x))) %>% 
    dplyr::mutate(Soil_Treatment = factor(Soil_Treatment, levels = c("AC", "Ash", "Con"))) %>% 
    unite(trt, c("Soil_Type", "Soil_Treatment"), remove = FALSE) %>% 
    dplyr::rename(data = all_of(gsub("_mean", "", x)))
  
  df_summary <- dplyr::select(
    surv_summary, 
    Soil_Type, Soil_Treatment, Species, all_of(c(x, gsub("_mean", "_se", x)))) %>% 
    dplyr::mutate(Soil_Treatment = factor(Soil_Treatment, levels = c("AC", "Ash", "Con"))) %>% 
    unite(trt, c("Soil_Type", "Soil_Treatment"), remove = FALSE) %>% 
    dplyr::rename(mean = all_of(x), 
                  se = all_of(gsub("_mean", "_se", x)))
  
  iter <- sapply(unique(df$Species), function(y) {
    df2 <- dplyr::filter(df, Species == y)
    df2_summary <- dplyr::filter(df_summary, Species == y)
    
    df2_summary <- HSD.test(aov(data ~ trt, data = df2), trt = "trt", group = TRUE)$groups %>% 
      rownames_to_column("trt") %>% 
      dplyr::select(-data) %>% 
      merge(df2_summary)
    
    p <- ggplot(df2_summary, aes(Soil_Type, mean, fill = Soil_Treatment)) + 
      geom_bar(stat = "identity", position = "dodge", colour = "black", size = 1) +
      geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                    size = 1, width = 0.3, position = position_dodge(0.9)) +
      ggtitle(ifelse(x == plots[1], ifelse(y == "RF", "Rough Fescue", "Spotted Knapweed"), "")) +
      xlab("Soil Site")+
      ylab(paste0(ifelse(
        x == "germ_rat_mean", "Germination Rate\nafter 1 month", ifelse(
          x == "deaths_mean", "Mean deaths\nper pot", ifelse(
            x == "trial_surv_mean", "90-day Survival Rate", 
            "Survival Rate of\nGerminated Individuals"))))) +
      theme_classic(base_size = 16) +
      theme(
        text = element_text(family = "Times New Roman"),
        legend.position = c(0.18, 0.88),
        legend.background = element_rect(
          fill = "white", size = 1,linetype = "solid", colour = "black"),
        legend.title = element_text(face = "bold", size = 18),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(colour = "black"),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_line(size = 1, linetype = "solid", colour = "black"),
        axis.title = element_text(face = "bold", size = 16),
        axis.title.y = element_text(margin = margin(t = 0, 10, 0, 0)),
        axis.line = element_line(size = 1), 
        plot.title = element_text(face = "bold", hjust = 0.5)) +
      scale_fill_manual(
        values = c("dimgray", "darkgray", "gainsboro"),
        breaks = c("AC","Ash","Con"),
        labels = c("Activated Carbon", "Ash", "Control"),
        name = "Soil Amendment:") +
      scale_y_continuous(
        expand = c(0, 0), 
        limits = c(0, ifelse(x == "deaths_mean", 5, 1.25))) +
      scale_x_discrete(labels = c(Invaded = "Invaded", Pristine = "Pristine")) +
      geom_text(aes(label = groups, y = mean + se), position = position_dodge(0.9),
                vjust= -0.5, family = "serif", size = 5)
    
  }, simplify = FALSE, USE.NAMES = TRUE)
  
  # final <- ggarrange(plotlist = iter, common.legend = TRUE, legend = "none")
  
}, simplify = TRUE, USE.NAMES = TRUE)

final <- ggarrange(plotlist = surv_plots, common.legend = TRUE, legend = "bottom", 
                   ncol = 2, nrow = 4) +
  ggsave(filename = file.path(plot_dir, "survival.png"), width = 8.5, height = 11, dpi = 300)
  

```

Shifting gears to the elemental analyzer data now:

```{r}

analyzer <- read.csv(file.path(data_dir, "Analyzer.csv"))

elements <- names(dplyr::select(analyzer, where(is.numeric)))
el_aov <- sapply(elements, function(x) {
  form <- as.formula(paste0(x, "~ Soil_Type * Soil_Treatment"))
  aov(form, data = analyzer)
}, simplify = FALSE, USE.NAMES = TRUE)

el_residuals <- lapply(el_aov, residuals)
el_shapiro <- lapply(el_residuals, function(x)
  shapiro.test(x) %>% tidy() %>% dplyr::mutate(stat_name = names(statistic))) %>% 
  do.call(rbind, .)
el_levine <- sapply(elements, function(x) {
  form <- as.formula(paste0(x, "~ Soil_Type * Soil_Treatment"))
  leveneTest(form, data = analyzer) %>% tidy() %>% drop_na()
}, simplify = FALSE, USE.NAMES = TRUE) %>% 
  do.call(rbind, .)

# All assumptions are validated, good to use ANOVA
el_anova <- lapply(seq_along(el_aov), function(x) 
  anova(el_aov[[x]]) %>% tidy() %>% mutate(id = names(el_aov)[x])) %>% 
  magrittr::set_names(names(el_aov))
el_tukey <- lapply(seq_along(el_aov), function(x) 
  TukeyHSD(el_aov[[x]]) %>% tidy() %>% mutate(id = names(el_aov)[x])) %>% 
  magrittr::set_names(names(el_aov))

# Create summary data for plotting
analyzer_summary <- group_by(analyzer, Soil_Type, Soil_Treatment) %>% 
  dplyr::summarise(across(where(is.numeric), list(mean = mean, se = ~sd(.x) / sqrt(n()))), .groups = "drop")

# Write outputs
write.csv(el_shapiro, file.path(
  results_dir, "03a_soil_normality_assumptions.csv"), row.names = TRUE)
write.csv(el_levine, file.path(
  results_dir, "03b_soil_eq_vars_assumptions.csv"), row.names = TRUE)
lapply(el_anova, function(x) {
  df <- x
  df[nrow(df) + 1, ] <- NA
  write.table(df, file.path(results_dir, "03c_soil_anova.csv"), append = TRUE, 
              row.names = TRUE, sep = ",", na = "")})
lapply(el_tukey, function(x) {
  df <- x
  df[nrow(df) + 1, ] <- NA
  write.table(df, file.path(results_dir, "03c_soil_tukey.csv"), append = TRUE, 
              row.names = FALSE, sep = ",", na = "")})

# Plot results
analyzer_plots <- sapply(elements, function(x) {
  df <- dplyr::select(analyzer, c(Soil_Type, Soil_Treatment, all_of(x))) %>% 
    unite(trt, c("Soil_Type", "Soil_Treatment"), remove = FALSE) %>% 
    dplyr::mutate(Soil_Treatment = factor(Soil_Treatment, levels = c("AC", "Ash", "Con"))) %>% 
    dplyr::rename(data = 4)
  
  df_summary <- dplyr::select(analyzer_summary, c(Soil_Type, Soil_Treatment, starts_with(x))) %>% 
    dplyr::rename(mean = 3, se = 4) %>% 
    dplyr::mutate(Soil_Treatment = factor(Soil_Treatment, levels = c("AC", "Ash", "Con"))) %>% 
    unite(trt, c("Soil_Type", "Soil_Treatment"), remove = FALSE)
  
  # Get significance letters using HSD.test from agricolae package
  df_summary <- HSD.test(aov(data ~ trt, data = df), trt = "trt", group = TRUE)$groups %>% 
    rownames_to_column("trt") %>% 
    dplyr::select(-data) %>% 
    merge(df_summary)
  
  # Used to produce bar plots but not useful, boxplot more interpretable
  # p <- ggplot(df_summary, aes(Soil_Type, mean, fill = Soil_Treatment)) + 
  #   geom_bar(stat = "identity", position = "dodge", colour = "black", size = 1) +
  #   geom_errorbar(aes(ymin = mean - se, ymax = mean + se), 
  #                 size = 1, width = 0.3, position = position_dodge(0.9)) +
  #   xlab("Soil Site")+
  #   ylab(paste0("Total ", x, " (%)")) +
  #   theme_classic(base_size = 16) +
  #   theme(
  #     text = element_text(family = "Times New Roman"),
  #     legend.position = c(0.18, 0.88), 
  #     legend.background = element_rect(
  #       fill = "white", size = 1,linetype = "solid", colour = "black"),
  #     legend.title = element_text(face = "bold", size = 18),
  #     panel.grid.major = element_blank(),
  #     panel.grid.minor = element_blank(),
  #     axis.text = element_text(colour = "black"),
  #     axis.ticks.x = element_blank(),
  #     axis.title = element_text(face = "bold", size = 18)) + 
  #   scale_fill_manual(
  #     values = c("dimgray", "darkgray", "gainsboro"),
  #     breaks = c("AC","Ash","Con"),
  #     labels = c("Activated Carbon", "Ash", "Control"),
  #     name = "Soil Amendment") +
  #   scale_y_continuous(
  #     expand = c(0, 0), 
  #     limits = c(0, max(ceiling(df_summary$mean)))) +
  #   scale_x_discrete(labels = c(Invaded = "Invaded", Pristine = "Pristine")) +
  #   geom_text(aes(label = groups, y = mean + se), position = position_dodge(0.9), 
  #             vjust= -0.5, family = "serif", size = 5)
  
  p <- ggplot(df, aes(Soil_Type, data, fill = Soil_Treatment)) +
    geom_boxplot(lwd = 0.6, color = "black", width = 1) +
    xlab("Soil Site") +
    ylab(paste0("Total ", x, " (%)"))  +
    theme_classic(base_size = 14) +
    theme(
      text = element_text(family="Times New Roman"), 
      legend.position = c(0.18, 0.88),
      legend.background = element_rect(
        fill = "white", size = 1, linetype = "solid", colour = "black"),
      legend.title = element_text(face = "bold",size = 16), 
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.text = element_text(colour = "black"),
      axis.ticks.x = element_blank(),
      axis.ticks.y = element_line(size = 1, linetype = "solid", colour = "black"),
      axis.title = element_text(face = "bold",size = 16),
      axis.title.y = element_text(margin = margin(t = 0, 10, 0, 0)),
      axis.line = element_line(size = 1)) +
    scale_fill_manual(
      values = c("gray99", "gray66", "gray33"),
      breaks = c("AC", "Ash", "Con"),
      labels = c("Control", "Activated Carbon", "Ash"), 
      name = "Soil Amendment:") +
    scale_x_discrete(labels = c(INV = "Invaded", PRI = "Pristine")) +
    scale_y_continuous(
      expand = c(0, 0), 
      limits = c(
        ifelse(max(df$data) < 1 | max(df$data) - min(df$data) < 1, 
               round(min(df$data) - 0.1, digits = 1), min(floor(df$data))),
        ifelse(max(df$data) < 1 | max(df$data) - min(df$data) < 1, 
               round(max(df$data) + 0.1, digits = 1), max(ceiling(df$data)))))
}, simplify = FALSE, USE.NAMES = TRUE)

# Arrange final plot of carbon and nitrogen only
final <- ggarrange(plotlist = analyzer_plots[2:1], common.legend = TRUE, legend = "bottom") +
  ggsave(filename = file.path(plot_dir, "CN_plot.png"), width = 6, height = 3, dpi = 300)

```

