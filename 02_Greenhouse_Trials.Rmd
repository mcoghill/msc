---
title: "02_Greenhouse_Trials"
author: "Matt"
date: "9/14/2020"
output: html_document
---

The intention of this document is to perform scientific analysis of the greenhouse trials performed in my MSc. This will include everything from greenhouse temperature data to biomass and carbon sampling as well.

I'll start with biomass collected in the greenhouse. First, load some packages

```{r Load packages}

suppressMessages(suppressWarnings({
  ls <- c("tidyverse", "broom", "car", "ggpubr", "magick", "agricolae", 
          "extrafont", "rstatix", "emmeans", "ARTool")
  new_packages <- ls[!(ls %in% installed.packages()[, "Package"])]
  if(length(new_packages)) install.packages(new_packages)
  sapply(ls, library, character.only = TRUE, quietly = TRUE)[0]
  if(any(!fonts() %in% unlist(windowsFonts())) || length(fonts()) == 0) {
    font_import(prompt = FALSE)
    loadfonts(device = "win")}
  rm(ls, new_packages)}))

```

Next, initialize folders and load the data

```{r Set directories and load biomass data}

data_dir <- file.path("./02_Greenhouse/data")
plot_dir <- file.path("./02_Greenhouse/plots")
results_dir <- file.path("./02_Greenhouse/results")
dir.create(plot_dir, showWarnings = FALSE)
dir.create(results_dir, showWarnings = FALSE)

biomass <- read.csv(file.path(data_dir, "greenhouse_raw.csv"), header = TRUE) %>% 
  dplyr::mutate(Soil_Type = factor(Soil_Type, levels = c("Invaded", "Pristine")),
                Soil_Treatment = factor(Soil_Treatment, levels = c("Con", "AC", "Ash")), 
                AboveMass = ifelse(AboveMass == 0.001, 0, AboveMass),
                BelowMass = ifelse(BelowMass == 0.001, 0, BelowMass),
                TotalMass = AboveMass + BelowMass) %>% 
  dplyr::select(Soil_Type, Soil_Treatment, Species, TotalMass)

```

Let's see if the data are normal or not. This requires separating by species since they have very different growth patterns etc.

For both species, test if residuals are significantly different (lots of variation). If so, the data are not normal and something needs to be done to it.

```{r biomass stats}

anova_assum <- function(x, dv, rm_outliers = TRUE) {
  sapply(unique(x$Species), function(i) {
    df <- dplyr::filter(x, Species == i) %>% 
      dplyr::rename(var = sym(dv)) %>% 
      dplyr::select(Soil_Type, Soil_Treatment, Species, var) %>% 
      group_by(Soil_Type, Soil_Treatment) %>% 
      mutate(outlier = is_outlier(var), extreme = is_extreme(var)) %>% 
      ungroup() %>% 
      {if(rm_outliers) dplyr::filter(., !extreme) else .}
    norm_model <- lm(var ~ Soil_Type * Soil_Treatment, data = df)
    norm_plot_model <- ggqqplot(residuals(norm_model))
    shapiro_model <- shapiro_test(residuals(norm_model))
    groups <- df %>%
      group_by(Soil_Type, Soil_Treatment) %>% 
      dplyr::summarise(., n = n_distinct(var), .groups = "drop") %>% 
      pull(n)
    shapiro_groups <- if(any(groups == 1)) {
      data.frame(Soil_Type = NA, Soil_Treatment = NA, variable = dv, statistic = NA,
                 p = "Could not calculate Shapiro - only one unique value for one or some groups")
    } else {
      df %>%
        group_by(Soil_Type, Soil_Treatment) %>% 
        shapiro_test(var) %>% 
        dplyr::mutate(variable = dv)
    }
    norm_plot_groups <- ggqqplot(df, "var", ggtheme = theme_bw()) + 
      facet_grid(Soil_Type ~ Soil_Treatment)
    levene <- df %>% levene_test(var ~ Soil_Type * Soil_Treatment)
    df <- dplyr::rename(df, !!dv := var)
    return(list(data = df, shapiro_whole = shapiro_model, shapiro_groups = shapiro_groups,
                norm_plot_whole = norm_plot_model, norm_plot_groups = norm_plot_groups, 
                levene = levene))
  }, simplify = FALSE, USE.NAMES = TRUE)
}

bmass_assum <- anova_assum(biomass, "TotalMass", rm_outliers = FALSE)

bmass_normal_analysis <- lapply(bmass_assum, "[[", "shapiro_whole") %>% 
  do.call(rbind, .) %>% rownames_to_column("Species")
bmass_var_eq_analysis <- lapply(bmass_assum, "[[", "levene") %>% 
  do.call(rbind, .) %>% rownames_to_column("Species")

# Base data: Neither RF or SK pass normality assumptions. Only SK passes 
# equal variance assumption. Keep in mind, this is without filtering away the 
# outlier data yet. 

# Square root transforming will work with either the unfiltered or the filtered
# data. It will depend on the committee: If no extreme outliers is a consideration, 
# I will have to use this data transformation instead
bmass_sqrt <- dplyr::mutate(biomass, sqrt_mass = sqrt(TotalMass))
bmass_assum <- anova_assum(bmass_sqrt, "sqrt_mass", rm_outliers = FALSE)
bmass_normal_analysis <- lapply(bmass_assum, "[[", "shapiro_whole") %>% 
  do.call(rbind, .) %>% rownames_to_column("Species")
bmass_var_eq_analysis <- lapply(bmass_assum, "[[", "levene") %>% 
  do.call(rbind, .) %>% rownames_to_column("Species")

# The results came back passing all assumptions, and now a proper 2-way ANOVA can
# be carried out (and post hoc analysis, Tukey HSD):

anova_analysis <- function(x, dv) {
  sapply(unique(x$Species), function(i) {
    df <- dplyr::filter(x, Species == i) %>% 
      dplyr::rename(var = sym(dv)) %>% 
      dplyr::mutate(Soil_Treatment = factor(Soil_Treatment, levels = c("AC", "Ash", "Con")))
    aov <- df %>% anova_test(var ~ Soil_Type * Soil_Treatment)
    model <- lm(var ~ Soil_Type * Soil_Treatment, data = df)
    aov_type <- df %>% 
      group_by(Soil_Treatment) %>% 
      anova_test(var ~ Soil_Type, error = model)
    aov_treatment <- df %>% 
      group_by(Soil_Type) %>% 
      anova_test(var ~ Soil_Treatment, error = model)
    
    pwc_type <- if(all(aov_type$p < 0.05)) {
      df %>% 
        group_by(Soil_Type) %>% 
        emmeans_test(var ~ Soil_Treatment, p.adjust.method = "bonferroni") %>% 
        add_xy_position(x = "Soil_Type")
    } else {
      df %>% 
        group_by(Soil_Type) %>% 
        pairwise_t_test(var ~ Soil_Treatment, p.adjust.method = "bonferroni") %>% 
        add_xy_position(x = "Soil_Type")
    }
    
    pwc_treatment <- if(all(aov_treatment$p < 0.05)) {
      df %>% 
        group_by(Soil_Treatment) %>% 
        emmeans_test(var ~ Soil_Type, p.adjust.method = "bonferroni") %>% 
        add_xy_position(x = "Soil_Treatment")
    } else {
      df %>% 
        group_by(Soil_Treatment) %>% 
        pairwise_t_test(var ~ Soil_Type, p.adjust.method = "bonferroni") %>% 
        add_xy_position(x = "Soil_Treatment")
    }
    
    tukey <- df %>% 
      tukey_hsd(var ~ Soil_Type * Soil_Treatment) %>% 
      adjust_pvalue(method = "bonferroni")
    
    df <- dplyr::rename(df, !!dv := var)
    
    bxp_type <- ggboxplot(
      df, x = "Soil_Type", y = dv, 
      color = "Soil_Treatment", palette = "jco") + 
      stat_pvalue_manual(pwc_type) + 
      labs(
        subtitle = get_test_label(aov, detailed = TRUE),
        caption = get_pwc_label(pwc_type))
    
    bxp_treatment <- ggboxplot(
      df, x = "Soil_Treatment", y = dv, 
      color = "Soil_Type", palette = "jco") + 
      stat_pvalue_manual(pwc_treatment) + 
      labs(
        subtitle = get_test_label(aov, detailed = TRUE),
        caption = get_pwc_label(pwc_treatment))
    
    # Output PWC's more simply
    pwc_type <- data.frame(pwc_type) %>% 
      dplyr::select(-any_of(c("p.signif", "p.adj.signif", "y.position", "groups", 
                              "x", "xmin", "xmax", "df", "statistic"))) %>% 
      {if(!"n1" %in% names(.)) {
        dplyr::mutate(., n1 = (df %>% group_by(Soil_Type, Soil_Treatment) %>% 
                                 summarise(n = n(), .groups = "drop") %>% 
                                 pull(n))[1], n2 = n1)
      } else dplyr::mutate(., term = "Soil_Treatment")} 
    
    pwc_treatment <- data.frame(pwc_treatment) %>% 
      dplyr::select(-any_of(c("p.signif", "p.adj.signif", "y.position", "groups", 
                              "x", "xmin", "xmax", "df", "statistic"))) %>% 
      {if(!"n1" %in% names(.)) {
        dplyr::mutate(., n1 = (df %>% group_by(Soil_Type, Soil_Treatment) %>% 
                                 summarise(n = n(), .groups = "drop") %>% 
                                 pull(n))[1], n2 = n1)
      } else dplyr::mutate(., term = "Soil_Type")} 
    
    return(list(data = df, two_way = aov, tukey = tukey, one_way_type = aov_type,
                one_way_treatment = aov_treatment, pwc_type = pwc_type, 
                pwc_treatment = pwc_treatment, plot_type = bxp_type, plot_trt = bxp_treatment))
  }, simplify = FALSE, USE.NAMES = TRUE)
}

bmass_analysis <- anova_analysis(do.call(rbind, lapply(bmass_assum, "[[", "data")), "sqrt_mass")

# Prepare data for saving
analysis_input <- lapply(bmass_analysis, "[[", "data") %>% do.call(rbind, .) %>% 
  remove_rownames()

two_way <- lapply(bmass_analysis, function(x) {
  data.frame(x$two_way) %>% 
    dplyr::select(-p..05) %>% 
    rename_with(~str_c(., "_", paste0(x$data$Species[1])), where(is.numeric))}) %>% 
  Reduce(f = function(x, y) merge(x, y), x = .) %>% 
  dplyr::select(sort(tidyselect::peek_vars())) %>% 
  dplyr::relocate(Effect)

tukey <- lapply(bmass_analysis, function(x) {
  data.frame(x$tukey) %>% 
    dplyr::select(-c(p.adj.signif, null.value)) %>% 
    rename_with(~str_c(., "_", paste0(x$data$Species[1])), where(is.numeric))}) %>% 
  Reduce(f = function(x, y) merge(x, y), x = .) %>% 
  dplyr::select(sort(tidyselect::peek_vars())) %>% 
  dplyr::relocate(term, group1, group2)

anova_type <- lapply(bmass_analysis, function(x) {
  data.frame(x$one_way_type) %>% 
    dplyr::select(-p..05) %>% 
    rename_with(~str_c(., "_", paste0(x$data$Species[1])), where(is.numeric))}) %>% 
  Reduce(f = function(x, y) merge(x, y), x = .) %>% 
  dplyr::select(sort(tidyselect::peek_vars())) %>% 
  dplyr::relocate(Soil_Treatment, Effect)

anova_treatment <- lapply(bmass_analysis, function(x) {
  data.frame(x$one_way_treatment) %>% 
    dplyr::select(-p..05) %>% 
    rename_with(~str_c(., "_", paste0(x$data$Species[1])), where(is.numeric))}) %>% 
  Reduce(f = function(x, y) merge(x, y), x = .) %>% 
  dplyr::select(sort(tidyselect::peek_vars())) %>% 
  dplyr::relocate(Soil_Type, Effect)

pwc_type <- lapply(bmass_analysis, function(x) {
  x$pwc_type %>% 
    rename_with(~str_c(., "_", paste0(x$data$Species[1])), where(is.numeric))}) %>% 
  Reduce(f = function(x, y) merge(x, y), x = .) %>% 
  dplyr::select(sort(tidyselect::peek_vars())) %>% 
  dplyr::relocate(Soil_Type, term, .y., group1, group2) %>% 
  dplyr::relocate(starts_with("p.adj"), .after = starts_with("p_"))

pwc_treatment <- lapply(bmass_analysis, function(x) {
  x$pwc_treatment %>% 
    rename_with(~str_c(., "_", paste0(x$data$Species[1])), where(is.numeric))}) %>% 
  Reduce(f = function(x, y) merge(x, y), x = .) %>% 
  dplyr::select(sort(tidyselect::peek_vars())) %>% 
  dplyr::relocate(Soil_Treatment, term, .y., group1, group2) %>% 
  dplyr::relocate(starts_with("p.adj"), .after = starts_with("p_"))

# In both cases, there is a strong 'Soil_Treatment' effect, and a slight interaction
# effect ('Soil_Type:Soil_Treatment').
# Most of the differences are from using AC in the soils (which killed everything).

# Write outputs
write.csv(analysis_input, file.path(
  results_dir, "01a_biomass_input_data.csv"), row.names = FALSE)
write.csv(bmass_normal_analysis, file.path(
  results_dir, "01b_biomass_normal_assumptions.csv"), row.names = FALSE)
write.csv(bmass_var_eq_analysis, file.path(
  results_dir, "01c_biomass_var_eq_assumptions.csv"), row.names = FALSE)
write.csv(two_way, file.path(
  results_dir, "01d_biomass_two_way_anova.csv"), row.names = FALSE)
write.csv(tukey, file.path(
  results_dir, "01e_biomass_tukey_results.csv"), row.names = FALSE)
write.csv(anova_type, file.path(
  results_dir, "01f_biomass_one_way_soil_type.csv"), row.names = FALSE)
write.csv(anova_treatment, file.path(
  results_dir, "01g_biomass_one_way_soil_treatment.csv"), row.names = FALSE)
write.csv(pwc_type, file.path(
  results_dir, "01h_biomass_pairwise_comparisons_soil_type.csv"), row.names = FALSE)
write.csv(pwc_treatment, file.path(
  results_dir, "01i_biomass_pairwise_comparisons_soil_treatment.csv"), row.names = FALSE)


```

After the stats, let's make some figures from that data:

```{r biomass figures}

# First, let's make bar charts for the biomass, and afterwards a boxplot, then 
# finally a side-by-side interaction plot. For the bar chart, we need means and
# standard errors of the LogBiomass data, which means creating a new summarized data table
biomass_summary <- analysis_input %>% 
  dplyr::group_by(Soil_Type, Soil_Treatment, Species) %>% 
  dplyr::summarise(mean = mean(sqrt_mass), se = sd(sqrt_mass) / sqrt(n()), .groups = "drop")

#This basically tells us that rough fescue performed best in invaded soils. Odd, but it's a result.
#Now, since I mentioned interactions, I should provide interaction plots for visualization purposes
#I will make the plots and then join them with a common legend afterwards
interactions <- sapply(unique(biomass_summary$Species), function(x) {
  p <- ggplot(subset(biomass_summary, Species == x), 
              aes(Soil_Type, mean, group = Soil_Treatment, linetype = Soil_Treatment)) + 
    geom_line(size = 1) +
    geom_point(size = 2) +
    theme_classic(base_size = 14) +
    theme(
      text = element_text(family = "Times New Roman"),
      legend.position = "none",
      legend.background = element_rect(
        fill = "white",
        size = 1,
        linetype = "solid",
        colour = "black"
      ),
      legend.title = element_text(face = "bold"),
      axis.text = element_text(colour = "black"),
      axis.ticks.x = element_blank(),
      axis.ticks.y = element_line(size = 1, linetype = "solid", colour = "black"),
      axis.title = element_text(face = "bold", size = 16),
      axis.title.y = element_text(margin = margin(t = 0, 10, 0, 0)),
      axis.line = element_line(size = 1),
      plot.title = element_text(face = "bold", hjust = 0.5)
    ) +
    scale_y_continuous(expand = c(0, 0), limits = c(0, 2.5)) +
    scale_x_discrete(labels = c("Invaded", "Pristine")) +
    scale_linetype_manual(
      values = c("solid", "dashed", "dotted"),
      name = "Soil Treatment:",
      breaks = c("Con", "AC", "Ash"),
      labels = c("Control", "Activated Carbon", "Ash")
    ) +
    xlab("Soil Type") +
    ylab(expression(bold(sqrt("Biomass (g)")))) +
    ggtitle(ifelse(x == "RF", "Rough Fescue", "Spotted Knapweed"))
}, simplify = FALSE, USE.NAMES = TRUE)

#Now join those 2 graphs together
final <- ggarrange(plotlist = interactions, common.legend = TRUE, legend = "bottom") +
  ggsave(filename = file.path(plot_dir, "interactions.png"), width = 6, height = 3, dpi = 300)
#Export image at 600px wide x 300px tall

```

Now, plot biomass separated by species. There is also the option of adding an image of the plant to the graphs as well

```{r Biomass separated}

rf_img <- image_read(
  "https://live.staticflickr.com/2426/3990317298_1cfbb2e31f_o_d.jpg") %>% 
  image_rotate(90) %>% 
  as.raster()
rf_img_ar <- ncol(rf_img) / nrow(rf_img)

sk_img <- image_read(
  "https://upload.wikimedia.org/wikipedia/commons/2/2d/Centaurea_maculosa_Bozeman.jpg") %>% 
  as.raster()
sk_img_ar <- ncol(rf_img) / nrow(rf_img)

biomass_plot <- sapply(unique(biomass_summary$Species), function(x) {
  df <- subset(analysis_input, Species == x) %>% 
    unite(trt, c("Soil_Type", "Soil_Treatment"), remove = FALSE) %>% 
    dplyr::mutate(Soil_Treatment = factor(Soil_Treatment, levels = c("AC", "Ash", "Con")))
  
  # Get significance letters using HSD.test from agricolae package
  
  df_summary <- HSD.test(aov(sqrt_mass ~ trt, data = df), trt = "trt", group = TRUE, 
                         alpha = 0.05 / length(unique(df$Soil_Treatment))) %>% 
    .[c("means", "groups")] %>% 
    lapply(rownames_to_column, "trt") %>% 
    Reduce(f = function(x, y) merge(x, y), x = .) %>% 
    merge(subset(biomass_summary, Species == x) %>% 
            dplyr::select(starts_with("Soil")) %>% 
            unite(trt, c("Soil_Type", "Soil_Treatment"), remove = FALSE))
  
  p <- ggplot(df_summary, aes(Soil_Treatment, Q50, fill = Soil_Type)) +
    geom_bar(
      stat = "identity",
      position = "dodge",
      colour = "black",
      size = 1) +
    geom_errorbar(
      aes(
        ymin = ifelse(sqrt_mass - std < 0, 0.02, sqrt_mass - std), 
        ymax = sqrt_mass + std),
      size = 1,
      width = 0.3,
      position = position_dodge(0.9)) +
    ggtitle(ifelse(x == "RF", "Rough Fescue", "Spotted Knapweed")) +
    xlab("Soil Amendment") +
    ylab(expression(bold(sqrt("Biomass (g)")))) +
    scale_fill_manual(
      values = c("#5a5a5a", "#adadad"),
      breaks = c("Invaded", "Pristine"),
      labels = c("Invaded", "Pristine"),
      name = "Soil Type:") +
    theme_classic(base_size = 14) +
    theme(
      rect = element_rect(fill = "transparent"),
      text = element_text(family = "Times New Roman"),
      legend.position = c(0.12, 0.88),
      legend.background = element_rect(
        fill = "white",
        size = 1,
        linetype = "solid",
        colour = "black"),
      legend.title = element_text(face = "bold", size = 16),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.text = element_text(colour = "black"),
      axis.ticks.x = element_blank(),
      axis.ticks.y = element_line(size = 1, linetype = "solid", colour = "black"),
      axis.title = element_text(face = "bold", size = 16),
      axis.title.y = element_text(margin = margin(t = 0, 10, 0, 0)),
      axis.line = element_line(size = 1),
      plot.title = element_text(face = "bold", hjust = 0.5)) +
    scale_y_continuous(
      expand = c(0, 0), limits = c(0, 3.4), breaks = seq(0, 3, 0.5)) +
    scale_x_discrete(labels = c(AC = "AC", Ash = "Ash", Con = "Control")) +
    geom_text(
      aes(label = groups, y = sqrt_mass + std),
      position = position_dodge(0.9),
      vjust = -0.5,
      family = "serif", 
      size = 5)
}, simplify = FALSE, USE.NAMES = TRUE)

biomass_plot <- ggarrange(plotlist = biomass_plot, common.legend = TRUE, legend = "bottom") +
  ggsave(file.path(plot_dir, "bmass.png"), width = 6, height = 3, dpi = 300)

# If images are to be included, run the following lines:
final <- biomass_plot + 
  annotation_raster(rf_img, xmin = 0.14, 
                    xmax = 0.24,
                    ymin = 0.65,
                    ymax = 0.88) + 
  annotation_raster(sk_img, xmin = 0.64, 
                    xmax = 0.74,
                    ymin = 0.65,
                    ymax = 0.88) + 
  ggsave(file.path(plot_dir, "bmass_with_images.png"), width = 6, height = 3, dpi = 300)

```

I need to do some stuff with survival of the planted greenhouse plants as well:

```{r Survival data load and stats}

# Read in the survival data from the same spreadsheet
surv <- read.csv(file.path(data_dir, "greenhouse_raw.csv"), header = TRUE) %>% 
  dplyr::select(-c(AboveMass, BelowMass, Rep)) %>% 
  dplyr::mutate(Soil_Type = factor(Soil_Type, levels = c("Invaded", "Pristine")),
                Soil_Treatment = factor(Soil_Treatment, levels = c("Con", "AC", "Ash")), 
                germ_rat = Germinants / 5, 
                deaths = Germinants - Survival, 
                trial_surv = Survival / 5, 
                germ_surv = ifelse(Survival == 0 & Germinants == 0, 0, 
                                   Survival / Germinants))

# Create summarized results
surv_summary <- group_by(surv, Soil_Type, Soil_Treatment, Species) %>% 
  summarise(across(c(germ_rat, deaths, trial_surv, germ_surv), 
                   list(mean = mean, se = ~sd(.x) / sqrt(n()))), .groups = "drop")

# Generate list of names that will be used to filter and attribute things later
plots <- names(surv_summary)[endsWith(names(surv_summary), "mean")] %>% 
  gsub("_mean", "", .)

surv_assum <- sapply(plots, function(x) 
  anova_assum(surv, x, rm_outliers = FALSE), simplify = FALSE, USE.NAMES = TRUE)

# Extract results
germ_rat_norm <- lapply(surv_assum$germ_rat, "[[", "shapiro_whole") %>% 
  do.call(rbind, .) %>% rownames_to_column("Species")
death_norm <- lapply(surv_assum$deaths, "[[", "shapiro_whole") %>% 
  do.call(rbind, .) %>% rownames_to_column("Species")
trial_surv_norm <- lapply(surv_assum$trial_surv, "[[", "shapiro_whole") %>% 
  do.call(rbind, .) %>% rownames_to_column("Species")
germ_surv_norm <- lapply(surv_assum$germ_surv, "[[", "shapiro_whole") %>% 
  do.call(rbind, .) %>% rownames_to_column("Species")

# Nothing is normal, sqrt transform and retry

surv_trans <- dplyr::mutate(surv, across(all_of(plots), sqrt))

surv_assum <- sapply(plots, function(x) 
  anova_assum(surv_trans, x, rm_outliers = FALSE), simplify = FALSE, USE.NAMES = TRUE)

# Extract results
germ_rat_norm <- lapply(surv_assum$germ_rat, "[[", "shapiro_whole") %>% 
  do.call(rbind, .) %>% rownames_to_column("Species")
death_norm <- lapply(surv_assum$deaths, "[[", "shapiro_whole") %>% 
  do.call(rbind, .) %>% rownames_to_column("Species")
trial_surv_norm <- lapply(surv_assum$trial_surv, "[[", "shapiro_whole") %>% 
  do.call(rbind, .) %>% rownames_to_column("Species")
germ_surv_norm <- lapply(surv_assum$germ_surv, "[[", "shapiro_whole") %>% 
  do.call(rbind, .) %>% rownames_to_column("Species")

# Fixed germination rate, try other transformations for other variables

surv_trans <- dplyr::mutate(surv, across(all_of(plots[plots != "germ_rat"]), 
                                         ~ log10(max(.x + 1) - .x)), 
                            germ_rat = sqrt(germ_rat))

surv_assum <- sapply(plots, function(x) 
  anova_assum(surv_trans, x, rm_outliers = FALSE), simplify = FALSE, USE.NAMES = TRUE)

# Extract results
death_norm <- lapply(surv_assum$deaths, "[[", "shapiro_whole") %>% 
  do.call(rbind, .) %>% rownames_to_column("Species")
trial_surv_norm <- lapply(surv_assum$trial_surv, "[[", "shapiro_whole") %>% 
  do.call(rbind, .) %>% rownames_to_column("Species")
germ_surv_norm <- lapply(surv_assum$germ_surv, "[[", "shapiro_whole") %>% 
  do.call(rbind, .) %>% rownames_to_column("Species")

# Didn't help anything, try inversing

surv_trans <- dplyr::mutate(surv, across(all_of(plots[plots != "germ_rat"]), 
                                         ~ 1 / (max(.x + 1) - .x)), 
                            germ_rat = sqrt(germ_rat))

surv_assum <- sapply(plots, function(x) 
  anova_assum(surv_trans, x, rm_outliers = FALSE), simplify = FALSE, USE.NAMES = TRUE)

# Extract results
death_norm <- lapply(surv_assum$deaths, "[[", "shapiro_whole") %>% 
  do.call(rbind, .) %>% rownames_to_column("Species")
trial_surv_norm <- lapply(surv_assum$trial_surv, "[[", "shapiro_whole") %>% 
  do.call(rbind, .) %>% rownames_to_column("Species")
germ_surv_norm <- lapply(surv_assum$germ_surv, "[[", "shapiro_whole") %>% 
  do.call(rbind, .) %>% rownames_to_column("Species")

# No simple data transformations worked - use Friedman tests for non-parametric 
# two way ANOVA's

germ_rat_analysis <- anova_analysis(do.call(rbind, lapply(surv_assum$germ_rat, "[[", "data")), "germ_rat")

friedman_custom <- function(x, dv) {
  friedman <- sapply(unique(x$Species), function(i) {
    df <- x %>% 
      dplyr::select(-germ_rat) %>% 
      dplyr::filter(Species == i) %>% 
      dplyr::rename(var = sym(dv))
    df2 <- group_by(df, Soil_Type, Soil_Treatment) %>% 
      mutate(Soil_Treatment = paste0(Soil_Treatment, "_", row_number())) %>% 
      ungroup()
    df3 <- group_by(df, Soil_Type, Soil_Treatment) %>% 
      mutate(Soil_Type = paste0(Soil_Type, "_", row_number())) %>% 
      ungroup()
    
    fried_type <- df2 %>% friedman_test(var ~ Soil_Treatment | Soil_Type)
    fried_treat <- df3 %>% friedman_test(var ~ Soil_Type | Soil_Treatment)
    
    type_fx <- df2 %>% friedman_effsize(var ~ Soil_Treatment | Soil_Type)
    treat_fx <- df3 %>% friedman_effsize(var ~ Soil_Type | Soil_Treatment)
    
    pwc_type <- df2 %>%
      wilcox_test(var ~ Soil_Type, paired = FALSE, p.adjust.method = "bonferroni")
    
    pwc_treatment <- df3 %>%
      wilcox_test(var ~ Soil_Treatment, paired = FALSE, p.adjust.method = "bonferroni")
    
    return(list(fried_type = fried_type, fried_treat = fried_treat, type_fx = type_fx,
                treat_fx = treat_fx, pwc_type = pwc_type, pwc_treatment = pwc_treatment))
  }, simplify = FALSE, USE.NAMES = TRUE)
}

death_analysis <- friedman_custom(surv, "deaths")
trial_surv_analysis <- friedman_custom(surv, "trial_surv")
germ_surv_analysis <- friedman_custom(surv, "germ_surv")

# Compare to base ANOVA - did it matter that data wasn't normal etc.?

death_anova <- anova_analysis(surv, "deaths")
trial_surv_anova <- anova_analysis(surv, "trial_surv")
germ_surv_anova <- anova_analysis(surv, "germ_surv")

# Try ARTools package 
surv_trans <- group_by(surv, Soil_Type, Soil_Treatment, Species) %>% 
  dplyr::mutate(rep = as.factor(paste0("r", row_number()))) %>% 
  ungroup()

art_custom <- function(x, dv) {
  
  sapply(unique(x$Species), function(i) {
    df <- x %>% 
      dplyr::select(-germ_rat) %>% 
      dplyr::filter(Species == i) %>% 
      dplyr::rename(var = sym(dv))
    
    # Perform aligned rank transformation (ART)
    m <- art(var ~ Soil_Type * Soil_Treatment + (1|rep), data = df)
    
    # Run an ANOVA on the ART responses
    anova <- anova(m, response = "art") %>% broom::tidy() %>% 
      dplyr::select(-Term)
    pwc_type <- emmeans(artlm(m, "Soil_Type"), pairwise ~ Soil_Type)
    pwc_type <- merge(
      data.frame(pwc_type$emmeans),
      data.frame(pwc_type$contrasts) %>% mutate(Soil_Type = "Invaded"), 
      by = "Soil_Type", all = TRUE)
    pwc_treatment <- emmeans(artlm(m, "Soil_Treatment"), pairwise ~ Soil_Treatment)
    pwc_treatment <- cbind(data.frame(pwc_treatment$emmeans, pwc_treatment$contrasts))
    
    # contrasts P value is adjusted using tukey method for comparing a family
    # of 6 estimates
    contrasts <- contrast(emmeans(artlm(m, "Soil_Type:Soil_Treatment"), 
                                  ~ Soil_Type:Soil_Treatment), method = "pairwise",
                          interaction = FALSE) %>% 
      broom::tidy() %>% 
      dplyr::select(-term) %>% 
      dplyr::rename(t.ratio = statistic)
    interaction <- contrast(emmeans(artlm(m, "Soil_Type:Soil_Treatment"), 
                                    ~ Soil_Type:Soil_Treatment), method = "pairwise",
                            interaction = TRUE) %>% 
      broom::tidy() %>% 
      dplyr::select(-term) %>% 
      dplyr::rename(t.ratio = statistic)
    
    df <- dplyr::rename(df, !!dv := var)
    return(list(
      data = df, model = m, anova = anova, pwc_type = pwc_type, 
      pwc_treatment = pwc_treatment, contrasts = contrasts, interaction = interaction))
  }, simplify = FALSE, USE.NAMES = TRUE) 
}

death_art <- art_custom(surv_trans, "deaths")
death_out <- sapply(names(death_art$RF)[names(death_art$RF) != "model"], function(x) {
  do.call(rbind, lapply(death_art, "[[", x))}, simplify = FALSE, USE.NAMES = TRUE) %>% 
  lapply(function(x) 
    x %>% 
      rownames_to_column("species") %>% 
      dplyr::select(-any_of("Species")) %>% 
      dplyr::rename(Species = species) %>% 
      dplyr::mutate(Species = substr(Species, 1, 2)))

trial_surv_art <- art_custom(surv_trans, "trial_surv")
trial_surv_out <- sapply(names(trial_surv_art$RF)[names(trial_surv_art$RF) != "model"], function(x) {
  do.call(rbind, lapply(trial_surv_art, "[[", x))}, simplify = FALSE, USE.NAMES = TRUE) %>% 
  lapply(function(x) 
    x %>% 
      rownames_to_column("species") %>% 
      dplyr::select(-any_of("Species")) %>% 
      dplyr::rename(Species = species) %>% 
      dplyr::mutate(Species = substr(Species, 1, 2)))

germ_surv_art <- art_custom(surv_trans, "germ_surv")
germ_surv_out <- sapply(names(germ_surv_art$RF)[names(germ_surv_art$RF) != "model"], function(x) {
  do.call(rbind, lapply(germ_surv_art, "[[", x))}, simplify = FALSE, USE.NAMES = TRUE) %>% 
  lapply(function(x) 
    x %>% 
      rownames_to_column("species") %>% 
      dplyr::select(-any_of("Species")) %>% 
      dplyr::rename(Species = species) %>% 
      dplyr::mutate(Species = substr(Species, 1, 2)))

# Write outputs
germ_rat_out <- sapply(names(germ_rat_analysis$RF)[
  !names(germ_rat_analysis$RF) %in% c("plot_type", "plot_trt")], function(x) {
  do.call(rbind, lapply(germ_rat_analysis, "[[", x))}, simplify = FALSE, USE.NAMES = TRUE) %>% 
  lapply(function(x) 
    data.frame(x) %>% 
      rownames_to_column("species") %>% 
      dplyr::select(-any_of("Species")) %>% 
      dplyr::rename(Species = species) %>% 
      dplyr::mutate(Species = substr(Species, 1, 2)))

# Prepare data for saving
germ_rat_analysis_input <- lapply(bmass_analysis, "[[", "data") %>% do.call(rbind, .) %>% 
  remove_rownames()

germ_rat_two_way <- lapply(germ_rat_analysis, function(x) {
  data.frame(x$two_way) %>% 
    dplyr::select(-p..05) %>% 
    rename_with(~str_c(., "_", paste0(x$data$Species[1])), where(is.numeric))}) %>% 
  Reduce(f = function(x, y) merge(x, y), x = .) %>% 
  dplyr::select(sort(tidyselect::peek_vars())) %>% 
  dplyr::relocate(Effect)

germ_rat_tukey <- lapply(germ_rat_analysis, function(x) {
  data.frame(x$tukey) %>% 
    dplyr::select(-c(p.adj.signif, null.value)) %>% 
    rename_with(~str_c(., "_", paste0(x$data$Species[1])), where(is.numeric))}) %>% 
  Reduce(f = function(x, y) merge(x, y), x = .) %>% 
  dplyr::select(sort(tidyselect::peek_vars())) %>% 
  dplyr::relocate(term, group1, group2)

germ_rat_anova_type <- lapply(germ_rat_analysis, function(x) {
  data.frame(x$one_way_type) %>% 
    dplyr::select(-p..05) %>% 
    rename_with(~str_c(., "_", paste0(x$data$Species[1])), where(is.numeric))}) %>% 
  Reduce(f = function(x, y) merge(x, y), x = .) %>% 
  dplyr::select(sort(tidyselect::peek_vars())) %>% 
  dplyr::relocate(Soil_Treatment, Effect)

germ_rat_anova_treatment <- lapply(germ_rat_analysis, function(x) {
  data.frame(x$one_way_treatment) %>% 
    dplyr::select(-p..05) %>% 
    rename_with(~str_c(., "_", paste0(x$data$Species[1])), where(is.numeric))}) %>% 
  Reduce(f = function(x, y) merge(x, y), x = .) %>% 
  dplyr::select(sort(tidyselect::peek_vars())) %>% 
  dplyr::relocate(Soil_Type, Effect)

germ_rat_pwc_type <- lapply(germ_rat_analysis, function(x) {
  x$pwc_type %>% 
    rename_with(~str_c(., "_", paste0(x$data$Species[1])), where(is.numeric))}) %>% 
  Reduce(f = function(x, y) merge(x, y), x = .) %>% 
  dplyr::select(sort(tidyselect::peek_vars())) %>% 
  dplyr::relocate(Soil_Type, term, .y., group1, group2) %>% 
  dplyr::relocate(starts_with("p.adj"), .after = starts_with("p_"))

germ_rat_pwc_treatment <- lapply(germ_rat_analysis, function(x) {
  x$pwc_treatment %>% 
    rename_with(~str_c(., "_", paste0(x$data$Species[1])), where(is.numeric))}) %>% 
  Reduce(f = function(x, y) merge(x, y), x = .) %>% 
  dplyr::select(sort(tidyselect::peek_vars())) %>% 
  dplyr::relocate(Soil_Treatment, term, .y., group1, group2) %>% 
  dplyr::relocate(starts_with("p.adj"), .after = starts_with("p_"))

germ_rat_norm_assum <- lapply(surv_assum$germ_rat, "[[", "shapiro_whole") %>% 
  do.call(rbind, .) %>% rownames_to_column("Species")
germ_rat_var_eq_assum <- lapply(surv_assum$germ_rat, "[[", "levene") %>% 
  do.call(rbind, .) %>% rownames_to_column("Species")

write.csv(germ_rat_analysis_input, file.path(
  results_dir, "02a_germ_rat_input_data.csv"), row.names = FALSE)
write.csv(germ_rat_norm_assum, file.path(
  results_dir, "02b_germ_rat_normal_assumption.csv"), row.names = FALSE)
write.csv(germ_rat_var_eq_assum, file.path(
  results_dir, "02c_germ_rat_var_eq_assumption.csv"), row.names = FALSE)
write.csv(germ_rat_two_way, file.path(
  results_dir, "02d_germ_rat_two_way.csv"), row.names = FALSE)
write.csv(germ_rat_tukey, file.path(
  results_dir, "02e_germ_rat_tukey_results.csv"), row.names = FALSE)
write.csv(germ_rat_anova_type, file.path(
  results_dir, "02f_germ_rat_one_way_soil_type.csv"), row.names = FALSE)
write.csv(germ_rat_anova_treatment, file.path(
  results_dir, "02g_germ_rat_one_way_soil_treatment.csv"), row.names = FALSE)
write.csv(germ_rat_pwc_type, file.path(
  results_dir, "02h_germ_rat_pairwise_comparisons_soil_type.csv"), row.names = FALSE)
write.csv(germ_rat_pwc_treatment, file.path(
  results_dir, "02i_germ_rat_pairwise_comparisons_soil_treatment.csv"), row.names = FALSE)

lapply(c("death", "germ_surv", "trial_surv"), function(x) {
  y <- get(paste0(x, "_out"))
  norm_assum <- surv_assum[[ifelse(x == "death", paste0(x, "s"), x)]] %>% 
    lapply("[[", "shapiro_whole") %>% do.call(rbind, .) %>% rownames_to_column("Species")
  var_eq_assum <- surv_assum[[ifelse(x == "death", paste0(x, "s"), x)]] %>% 
    lapply("[[", "levene") %>% do.call(rbind, .) %>% rownames_to_column("Species")
  id <- case_when(x == "death" ~ "03",
                  x == "germ_surv" ~ "04",
                  x == "trial_surv" ~ "05")
  write.csv(norm_assum, file.path(
    results_dir, paste0(id, "a_", x, "_normal_assumption.csv")), row.names = FALSE)
  write.csv(var_eq_assum, file.path(
    results_dir, paste0(id, "b_", x, "_var_eq_assumption.csv")), row.names = FALSE)
  write.csv(y$anova, file.path(
    results_dir, paste0(id, "c_", x, "_two_way_anova.csv")), row.names = FALSE)
  write.csv(y$contrasts, file.path(
    results_dir, paste0(id, "d_", x, "_contrasts.csv")), row.names = FALSE)
  write.csv(y$pwc_treatment, file.path(
    results_dir, paste0(id, "e_", x, "_pairwise_soil_treatment.csv")), row.names = FALSE)
  write.csv(y$pwc_type, file.path(
    results_dir, paste0(id, "f_", x, "_pairwise_soil_type.csv")), row.names = FALSE)
  write.csv(y$interaction, file.path(
    results_dir, paste0(id, "g_", x, "_interactions.csv")), row.names = FALSE)
})

```

Now plot the survival data

```{r survival plots}

surv_plots <- sapply(plots, function(x) {
  
  df <- dplyr::select(surv, Soil_Type, Soil_Treatment, Species, all_of(x)) %>% 
    dplyr::mutate(Soil_Treatment = factor(Soil_Treatment, levels = c("AC", "Ash", "Con"))) %>% 
    unite(trt, c("Soil_Type", "Soil_Treatment"), remove = FALSE) %>% 
    dplyr::rename(data = all_of(x))
  
  df_summary <- dplyr::select(
    surv_summary, 
    Soil_Type, Soil_Treatment, Species, all_of(paste0(x, c("_mean", "_se")))) %>% 
    dplyr::mutate(Soil_Treatment = factor(Soil_Treatment, levels = c("AC", "Ash", "Con"))) %>% 
    unite(trt, c("Soil_Type", "Soil_Treatment"), remove = FALSE) %>% 
    dplyr::rename(mean = all_of(paste0(x, "_mean")), 
                  se = all_of(paste0(x, "_se")))
  
  iter <- sapply(unique(df$Species), function(y) {
    df2 <- dplyr::filter(df, Species == y)
    
    df2_summary <- HSD.test(aov(data ~ trt, data = df2), trt = "trt", group = TRUE, 
                            alpha = 0.05 / length(unique(df2$Soil_Treatment))) %>% 
      .[c("means", "groups")] %>% 
      lapply(rownames_to_column, "trt") %>% 
      Reduce(f = function(x, y) merge(x, y), x = .) %>% 
      merge(subset(df_summary, Species == y) %>% 
              dplyr::select(starts_with("Soil")) %>% 
              unite(trt, c("Soil_Type", "Soil_Treatment"), remove = FALSE))
    
    p <- ggplot(df2_summary, aes(Soil_Type, data, fill = Soil_Treatment)) + 
      geom_bar(stat = "identity", position = "dodge", colour = "black", size = 1) +
      geom_errorbar(
        aes(
          ymin = ifelse(data - std < 0, 0.02, data - std), 
          ymax = data + std),
        size = 1, width = 0.3, position = position_dodge(0.9)) +
      ggtitle(ifelse(x == plots[1], ifelse(y == "RF", "Rough Fescue", "Spotted Knapweed"), "")) +
      xlab("Soil Site") +
      ylab(case_when(
        x == "germ_rat" ~ "Germination Rate\nafter 1 month",
        x == "deaths" ~ "Mean deaths\nper pot",
        x == "trial_surv" ~ "90-day Survival Rate", 
        x == "germ_surv" ~ "Survival Rate of\nGerminated Individuals",
        TRUE ~ "error")) +
      theme_classic(base_size = 16) +
      theme(
        text = element_text(family = "Times New Roman"),
        legend.position = c(0.18, 0.88),
        legend.background = element_rect(
          fill = "white", size = 1,linetype = "solid", colour = "black"),
        legend.title = element_text(face = "bold", size = 18),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(colour = "black"),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_line(size = 1, linetype = "solid", colour = "black"),
        axis.title = element_text(face = "bold", size = 16),
        axis.title.y = element_text(margin = margin(t = 0, 10, 0, 0)),
        axis.line = element_line(size = 1), 
        plot.title = element_text(face = "bold", hjust = 0.5)) +
      scale_fill_manual(
        values = c("dimgray", "darkgray", "gainsboro"),
        breaks = c("AC","Ash","Con"),
        labels = c("Activated Carbon", "Ash", "Control"),
        name = "Soil Amendment:") +
      scale_y_continuous(
        expand = c(0, 0), 
        limits = c(0, ifelse(x == "deaths", 5, 1.5))) +
      scale_x_discrete(labels = c(Invaded = "Invaded", Pristine = "Pristine")) +
      geom_text(aes(label = groups, y = data + std), 
                position = position_dodge(0.9),
                vjust = -0.5, family = "serif", size = 5)
    
  }, simplify = FALSE, USE.NAMES = TRUE)
  
  # final <- ggarrange(plotlist = iter, common.legend = TRUE, legend = "none")
  
}, simplify = TRUE, USE.NAMES = TRUE)

final <- ggarrange(plotlist = surv_plots, common.legend = TRUE, legend = "bottom", 
                   ncol = 2, nrow = 4) +
  ggsave(filename = file.path(plot_dir, "survival.png"), width = 8.5, height = 11, dpi = 300)
  

```

Shifting gears to the elemental analyzer data now:

```{r Elemental analyzer data load stats and figure}

analyzer <- read.csv(file.path(data_dir, "Analyzer.csv")) %>% 
  dplyr::mutate(Species = "all") # For tricking my function

el_assum <- lapply(list(
  Nitrogen = anova_assum(analyzer, "Nitrogen", rm_outliers = FALSE), 
  Carbon = anova_assum(analyzer, "Carbon", rm_outliers = FALSE), 
  Hydrogen = anova_assum(analyzer, "Hydrogen", rm_outliers = FALSE)), "[[", "all")

# All assumptions are validated, good to use ANOVA
el_anova <- lapply(el_assum, function(x) 
  anova_analysis(x$data, names(x$data)[4])[[1]])

# Prepare data for saving

el_norm_assum <- lapply(el_assum, "[[", "shapiro_whole") %>% 
  do.call(rbind, .) %>% rownames_to_column("Element")
el_var_eq_assum <- lapply(el_assum, "[[", "levene") %>% 
  do.call(rbind, .) %>% rownames_to_column("Element")

el_analysis_input <- lapply(el_anova, "[[", "data") %>% 
  lapply(function(x) pivot_longer(x, cols = c("Nitrogen", "Carbon", "Hydrogen")[
    c("Nitrogen", "Carbon", "Hydrogen") %in% names(x)], names_to = "Element", 
    values_to = "total")) %>% 
  do.call(rbind, .) %>% 
  remove_rownames()

el_analysis_two_way <- lapply(el_anova, function(x) {
  data.frame(x$two_way) %>% 
    dplyr::select(-p..05) %>% 
    rename_with(~str_c(., "_", paste0(names(x$data)[4])), where(is.numeric))}) %>% 
  Reduce(f = function(x, y) merge(x, y), x = .) %>% 
  dplyr::select(sort(tidyselect::peek_vars())) %>% 
  dplyr::relocate(Effect)

el_analysis_tukey <- lapply(el_anova, function(x) {
  data.frame(x$tukey) %>% 
    dplyr::select(-c(p.adj.signif, null.value)) %>% 
    rename_with(~str_c(., "_", paste0(names(x$data)[4])), where(is.numeric))}) %>% 
  Reduce(f = function(x, y) merge(x, y), x = .) %>% 
  dplyr::select(sort(tidyselect::peek_vars())) %>% 
  dplyr::relocate(term, group1, group2)

el_analysis_anova_type <- lapply(el_anova, function(x) {
  data.frame(x$one_way_type) %>% 
    dplyr::select(-p..05) %>% 
    rename_with(~str_c(., "_", paste0(names(x$data)[4])), where(is.numeric))}) %>% 
  Reduce(f = function(x, y) merge(x, y), x = .) %>% 
  dplyr::select(sort(tidyselect::peek_vars())) %>% 
  dplyr::relocate(Soil_Treatment, Effect)

el_analysis_anova_treatment <- lapply(el_anova, function(x) {
  data.frame(x$one_way_treatment) %>% 
    dplyr::select(-p..05) %>% 
    rename_with(~str_c(., "_", paste0(names(x$data)[4])), where(is.numeric))}) %>% 
  Reduce(f = function(x, y) merge(x, y), x = .) %>% 
  dplyr::select(sort(tidyselect::peek_vars())) %>% 
  dplyr::relocate(Soil_Type, Effect)

el_analysis_pwc_type <- lapply(el_anova, function(x) {
  x$pwc_type %>% 
    rename_with(~str_c(., "_", paste0(names(x$data)[4])), where(is.numeric))}) %>% 
  Reduce(f = function(x, y) merge(x, y), x = .) %>% 
  dplyr::select(sort(tidyselect::peek_vars())) %>% 
  dplyr::relocate(Soil_Type, term, .y., group1, group2) %>% 
  dplyr::relocate(starts_with("p.adj"), .after = starts_with("p_"))

el_analysis_pwc_treatment <- lapply(el_anova, function(x) {
  x$pwc_treatment %>% 
    rename_with(~str_c(., "_", paste0(names(x$data)[4])), where(is.numeric))}) %>% 
  Reduce(f = function(x, y) merge(x, y), x = .) %>% 
  dplyr::select(sort(tidyselect::peek_vars())) %>% 
  dplyr::relocate(Soil_Treatment, term, .y., group1, group2) %>% 
  dplyr::relocate(starts_with("p.adj"), .after = starts_with("p_"))

# Create summary data for plotting
# analyzer_summary <- group_by(analyzer, Soil_Type, Soil_Treatment) %>% 
#   dplyr::summarise(across(where(is.numeric), list(mean = mean, se = ~sd(.x) / sqrt(n()))), .groups = "drop")

# Write outputs
write.csv(el_analysis_input, file.path(
  results_dir, "06a_elemental_analysis_input_data.csv"), row.names = FALSE)
write.csv(el_norm_assum, file.path(
  results_dir, "06b_elemental_analysis_normal_assumption.csv"), row.names = FALSE)
write.csv(el_var_eq_assum, file.path(
  results_dir, "06c_elemental_analysis_var_eq_assumption.csv"), row.names = FALSE)
write.csv(el_analysis_two_way, file.path(
  results_dir, "06d_elemental_analysis_two_way.csv"), row.names = FALSE)
write.csv(el_analysis_tukey, file.path(
  results_dir, "06e_elemental_analysis_tukey_results.csv"), row.names = FALSE)
write.csv(el_analysis_anova_type, file.path(
  results_dir, "06f_elemental_analysis_one_way_soil_type.csv"), row.names = FALSE)
write.csv(el_analysis_anova_treatment, file.path(
  results_dir, "06g_elemental_analysis_one_way_soil_treatment.csv"), row.names = FALSE)
write.csv(el_analysis_pwc_type, file.path(
  results_dir, "06h_elemental_analysis_pairwise_comparisons_soil_type.csv"), row.names = FALSE)
write.csv(el_analysis_pwc_treatment, file.path(
  results_dir, "06i_elemental_analysis_pairwise_comparisons_soil_treatment.csv"), row.names = FALSE)

# Plot results
analyzer_plots <- sapply(c("Nitrogen", "Carbon", "Hydrogen"), function(x) {
  df <- dplyr::select(analyzer, c(Soil_Type, Soil_Treatment, all_of(x))) %>% 
    unite(trt, c("Soil_Type", "Soil_Treatment"), remove = FALSE) %>% 
    dplyr::mutate(Soil_Treatment = factor(Soil_Treatment, levels = c("AC", "Ash", "Con"))) %>% 
    dplyr::rename(data = 4)
  
  p <- ggplot(df, aes(Soil_Type, data, fill = Soil_Treatment)) +
    geom_boxplot(lwd = 0.6, color = "black", width = 1) +
    xlab("Soil Site") +
    ylab(paste0("Total ", x, " (%)"))  +
    theme_classic(base_size = 14) +
    theme(
      text = element_text(family="Times New Roman"), 
      legend.position = c(0.18, 0.88),
      legend.background = element_rect(
        fill = "white", size = 1, linetype = "solid", colour = "black"),
      legend.title = element_text(face = "bold",size = 16), 
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.text = element_text(colour = "black"),
      axis.ticks.x = element_blank(),
      axis.ticks.y = element_line(size = 1, linetype = "solid", colour = "black"),
      axis.title = element_text(face = "bold",size = 16),
      axis.title.y = element_text(margin = margin(t = 0, 10, 0, 0)),
      axis.line = element_line(size = 1)) +
    scale_fill_manual(
      values = c("gray99", "gray66", "gray33"),
      breaks = c("AC", "Ash", "Con"),
      labels = c("Control", "Activated Carbon", "Ash"), 
      name = "Soil Amendment:") +
    scale_x_discrete(labels = c(INV = "Invaded", PRI = "Pristine")) +
    scale_y_continuous(
      expand = c(0, 0), 
      limits = c(
        ifelse(max(df$data) < 1 | max(df$data) - min(df$data) < 1, 
               round(min(df$data) - 0.1, digits = 1), min(floor(df$data))),
        ifelse(max(df$data) < 1 | max(df$data) - min(df$data) < 1, 
               round(max(df$data) + 0.1, digits = 1), max(ceiling(df$data)))))
}, simplify = FALSE, USE.NAMES = TRUE)

# Arrange final plot of carbon and nitrogen only
final <- ggarrange(plotlist = analyzer_plots[2:1], common.legend = TRUE, legend = "bottom") +
  ggsave(filename = file.path(plot_dir, "CN_plot.png"), width = 6, height = 3, dpi = 300)

```

